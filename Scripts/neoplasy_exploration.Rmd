---
title: "trait_exploration"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup}

knitr::opts_knit$set(root.dir = "/home/rstudio/NEOPLASY_PRIMATES")
knitr::opts_chunk$set(engine.path = list(
python = '/home/rstudio/NEOPLASY_PRIMATES/TreeCluster/venv/bin/python'))
getwd()

```

## Directory definition

```{r dirdef}
workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir,"Out") 
```

```{r check-wd}

getwd()

```

## Seed and library loading

```{r,warning=FALSE,message=FALSE}

set.seed(1998)

# General use libraries
library(ape)
library(RRphylo)
library(phytools)
library(reticulate)
library(dplyr)

# Non-concordant species retrieval 
library(stringdist)
library(taxize)
library(R.utils)

# Sort distances chunk
library(adephylo)
library(castor)

# Cluster merging
library(dplyr)

# Plotting
library(ggplot2)
library(tidyr)
library(dplyr)
library(viridis)
library(ggtree)
library(RColorBrewer)
library(svglite)

# From Alejandro
library(e1071)

# From Noelia
library(tidyverse)
library(ggpubr)
library(FactoMineR)
library(factoextra)
library(corrplot)
# library(GGally)
library(cowplot)
library(ape)
library(nlme)
# library(gt)
library(ggtree)
library(phytools)
library(RRphylo)
library(picante)
library(ggnewscale)
library(reshape)
library(palettetown)
library(compositions)
library(gt)
```

## Tree import and prunning

```{r tree}

primates_tree <- read.newick(file.path(dataDir,"233-GENOMES/science.abn7829_data_s4.nex.tree"))
tree_species <- primates_tree$tip.label

```
```{r traits}

cancer_traits <- read.csv(file.path(dataDir, "Neoplasia/species360_primates_neoplasia_20230519.csv"), sep = ",", header = TRUE)

# Remove whitespaces
cancer_traits[] <- lapply(cancer_traits, function(col) trimws(col))

# binarize
cancer_traits$label <- gsub(" ", "_", cancer_traits$species)

# Reorder and filter species
cancer_traits <- cancer_traits %>%
  select(family,species,label,common_name,necropsy_count,neoplasia_necropsy,neoplasia_prevalence, everything()) %>%
  filter(!is.na(neoplasia_prevalence))

```

```{r pruning}

# Prune the tree as Noelia does

common_names <- intersect(primates_tree$tip.label, cancer_traits$label)

pruned_primates.tree <- drop.tip(primates_tree, setdiff(primates_tree$tip.label, common_names))

cancer_traits <- cancer_traits %>%
  mutate(ordering = match(label, pruned_primates.tree$tip.label)) %>%
  arrange(ordering)  %>%
  filter(!is.na(ordering))

```

```{r statistics}

# Outlier 

cancer_traits_filt <- cancer_traits %>%
  select(-common_name, -ordering, -species)

cancer_traits_filt <- cancer_traits_filt %>%
  mutate(across(c(necropsy_count, neoplasia_necropsy, neoplasia_prevalence), as.double))


means <- t(cancer_traits_filt[,-which(colnames(cancer_traits_filt) %in% c("family", "label"))] %>% 
             summarize_all(., mean))

medians <- t(cancer_traits_filt[,-which(colnames(cancer_traits_filt) %in% c("family", "label"))] %>% 
  summarize_all(., median))

sds <- t(cancer_traits_filt[,-which(colnames(cancer_traits_filt) %in% c("family", "label"))] %>% 
  summarize_all(., list(sd)))

# MELT the df (longize it)
melted_dataframe_traits <- melt(cancer_traits_filt, id.vars = c("family", "label"), measure.vars = c("necropsy_count", "neoplasia_necropsy", "neoplasia_prevalence"))

colnames(melted_dataframe_traits) <- c("Family", "Species", "Trait", "value")

# Add stats to the melted df
for (i in 1:length(melted_dataframe_traits$Species)){
  if(as.character(melted_dataframe_traits$Trait[i]) %in% rownames(medians)){
    melted_dataframe_traits$median[i] <- as.numeric(as.character(medians[rownames(medians) == melted_dataframe_traits$Trait[i]]))
    melted_dataframe_traits$mean[i] <- as.numeric(as.character(means[rownames(means) == melted_dataframe_traits$Trait[i]]))
    melted_dataframe_traits$sd[i] <- as.numeric(as.character(sds[rownames(sds) == melted_dataframe_traits$Trait[i]]))
  }}

```


```{r statistics_per_fam}

calculate_stat <- function(stat_fn) {
  lapply(unique(cancer_traits_filt$family), function(fam) {
    subset_df <- cancer_traits_filt[cancer_traits_filt$family == fam, ]
    stats <- subset_df[,-which(colnames(subset_df) %in% c("label", "family"))] %>% 
               summarize_all(stat_fn)
    data.frame(family = fam, stats)
  })
}

fam_means_list <- calculate_stat(mean)
fam_medians_list <- calculate_stat(median)
fam_sds_list <- calculate_stat(sd)

bind_rows_df <- function(list_data) {
  do.call(rbind, list_data)
}

fam_means <- bind_rows_df(fam_means_list)
fam_medians <- bind_rows_df(fam_medians_list)
fam_sds <- bind_rows_df(fam_sds_list)

for (i in 1:length(melted_dataframe_traits$Species)){
  current_family <- melted_dataframe_traits$Family[i]
  current_trait <- as.character(melted_dataframe_traits$Trait[i])
  
  if(current_trait %in% colnames(fam_means)){
    melted_dataframe_traits$mean_fam[i] <- fam_means[fam_means$family == current_family, current_trait]
    melted_dataframe_traits$median_fam[i] <- fam_medians[fam_medians$family == current_family, current_trait]
    melted_dataframe_traits$sd_fam[i] <- fam_sds[fam_sds$family == current_family, current_trait]
  }
}


```


```{r top_bottom definitions}

# Compute top bottom definitions
# global
melted_dataframe_traits <- melted_dataframe_traits %>%
  dplyr::group_by(Trait) %>% 
  mutate(label = case_when(
    value < median - sd ~ "low_extreme", 
    value > median + sd ~ "high_extreme",
    TRUE ~ "normal")) %>%
      mutate(outlier = case_when(
        value < quantile(value, 0.25,na.rm=TRUE) - 1.5 * IQR(value, na.rm=TRUE) ~ paste0("low_outlier_",Trait),
        value > quantile(value, 0.75,na.rm=TRUE) + 1.5 * IQR(value, na.rm=TRUE) ~ paste0("high_outlier_",Trait),
        TRUE ~ "no"))

# global 3sd calculation
melted_dataframe_traits <- melted_dataframe_traits %>%
  dplyr::group_by(Trait) %>% 
  mutate(label_2sd = case_when(
    value < median - 2*sd ~ "very_low_extreme", 
    value > median + 2*sd ~ "very_high_extreme",
    TRUE ~ "normal"))
# by family
melted_dataframe_traits <- melted_dataframe_traits %>%
  dplyr::group_by(Family, Trait) %>% 
  mutate(z_score_fam = (value-mean)/sd) %>%
  mutate(label_family = case_when(
    value < median_fam - sd_fam ~ "low_extreme", 
    value > median_fam + sd_fam ~ "high_extreme",
    TRUE ~ "normal"))

# family 2sd calculation
melted_dataframe_traits <- melted_dataframe_traits %>%
  dplyr::group_by(Family, Trait) %>%
  mutate(z_score_fam_2sd = (value-mean)/(2*sd)) %>%
  mutate(label_family_2sd = case_when(
    value < median_fam - 2*sd_fam ~ "very_low_extreme", 
    value > median_fam + 2*sd_fam ~ "very_high_extreme",
    TRUE ~ "normal"))

spread_df <- melted_dataframe_traits %>%
  spread(Trait, value)
```

```{r correlation plots, fig.height = 5, fig.width = 10, dev = 'svg'}

# Filter dataframe for x and y values
df_x <- melted_dataframe_traits[melted_dataframe_traits$Trait == "necropsy_count", ]
df_y <- melted_dataframe_traits[melted_dataframe_traits$Trait == "neoplasia_necropsy", ]

# Merge them based on a common identifier (assuming you have an 'ID' column)
merged_df <- merge(df_x, df_y, by=c("Species","Family"))

# Map_plot
# Create a scatterplot
scatter_plot <- ggplot(data = merged_df, 
                      aes(x = value.x, y = value.y, color = Family)) + 
  geom_point(data = subset(merged_df, 
                      !(outlier.y %in% c("high_outlier_neoplasia_necropsy", "low_outlier_neoplasia_necropsy"))),
                      size = 4) +  
  # Plot outliers for y variable with a different shape
  geom_point(data = subset(merged_df, outlier.y %in% c("high_outlier_neoplasia_necropsy", "low_outlier_neoplasia_necropsy")),
             aes(shape = outlier.y), size = 4) +
  scale_shape_manual(values = c("high_outlier_neoplasia_necropsy" = 17, "low_outlier_neoplasia_necropsy" = 17)) +
  
  # Label species that are outliers for y variable
  geom_text(data = subset(merged_df, outlier.y %in% c("high_outlier_neoplasia_necropsy", "low_outlier_neoplasia_necropsy")),
            aes(label = Species), nudge_y = 1.5, size = 4, vjust = "right", hjust = "top") +
  
  labs(x = "Necropsy Count", y = "Neoplasia/Necropsy") +
  theme_minimal() +
  geom_smooth(method = "lm", se = TRUE, color="black") +
  theme(
    axis.title.x = element_text(size = 10, hjust = 0.5, margin = margin(t = 20, b = 10)),
    axis.title.y = element_text(size = 10, angle = 90, hjust = 0.5, margin = margin(t = 20, b = 10)),
    legend.position = "none")

print(scatter_plot)

model <- lm(value.y ~ value.x, data = merged_df)
summary(model)

```
## Top-to-bottom plots
### Median - 1SD
```{r top-bottom plot with out, fig.height = 8, fig.width = 10, dev = 'svg'}

df_z <- melted_dataframe_traits[melted_dataframe_traits$Trait == "neoplasia_prevalence", ]
df_z$median_fam <- factor(df_z$median_fam, levels = unique(df_z$median_fam))

# With outliers
ggplot(data = df_z, 
       aes(x = value, 
           y = Family)) +
  geom_point(data = subset(df_z, 
                        !(label_family %in% c("low_extreme", "normal", "high_extreme"))),
                        size = 4) +
  geom_point(data = subset(df_z, label_family %in% c("low_extreme", "normal", "high_extreme")),
               aes(shape = label_family, color = Family), size = 4) +
  scale_shape_manual(values = c("low_extreme" = 22, "normal" = 21, "high_extreme" = 24)) +
  stat_summary(fun.x = median, geom = "errorbar",
        aes(xmax = ..x.., xmin = ..x..), linewidth = 1, color = pokepal("rayquaza", spread = 1)) +
  geom_vline(aes(xintercept = median), linetype = "dotted", color = pokepal("rayquaza", spread = 1)) +
    labs(x = "Neoplasia Prevalence", y = "Families") +
  theme(
    axis.title.x = element_text(size = 10, hjust = 0.5, margin = margin(t = 20, b = 10)),
    axis.title.y = element_text(size = 10, angle = 90, hjust = 0.5, margin = margin(t = 20, b = 20)),
    legend.position = "none") + 
  xlim(0,0.5) 
```

### Median - 1SD without outliers

```{r top-bottom plot wo outliers, fig.height = 8, fig.width = 10, dev = 'svg'}

# Without outliers

df_z_nooutlier <- df_z[df_z$outlier == "no", ]

ggplot(data = df_z_nooutlier, 
       aes(x = value, 
           y = Family)) +
  geom_point(data = subset(df_z_nooutlier, 
                        !(label_family %in% c("low_extreme", "normal", "high_extreme"))),
                        size = 4) +
  geom_point(data = subset(df_z_nooutlier, label_family %in% c("low_extreme", "normal", "high_extreme")),
               aes(shape = label_family, color = Family), size = 4) +
  scale_shape_manual(values = c("low_extreme" = 22, "normal" = 21, "high_extreme" = 24)) +
  stat_summary(fun.x = median, geom = "errorbar",
        aes(xmax = ..x.., xmin = ..x..), linewidth = 1, color = pokepal("rayquaza", spread = 1)) +
  geom_vline(aes(xintercept = median), linetype = "dotted", color = pokepal("rayquaza", spread = 1)) +
    labs(x = "Neoplasia Prevalence", y = "Families") +
  theme(
    axis.title.x = element_text(size = 10, hjust = 0.5, margin = margin(t = 20, b = 10)),
    axis.title.y = element_text(size = 10, angle = 90, hjust = 0.5, margin = margin(t = 20, b = 20)),
    legend.position = "none") + 
  xlim(0,0.25) 

```

### Median - 2SD
```{r top-bottom plot 2sd, fig.height = 8, fig.width = 10, dev = 'svg'}

ggplot(data = df_z, 
       aes(x = value, 
           y = Family)) +
  geom_point(data = subset(df_z, 
                        !(label_family_2sd %in% c("very_low_extreme", "normal", "very_high_extreme"))),
                        size = 4) +
  geom_point(data = subset(df_z, label_family_2sd %in% c("very_low_extreme", "normal", "very_high_extreme")),
               aes(shape = label_family_2sd, color = Family), size = 4) +
  scale_shape_manual(values = c("very_low_extreme" = 22, "normal" = 21, "very_high_extreme" = 24)) +
  stat_summary(fun.x = median, geom = "errorbar",
        aes(xmax = ..x.., xmin = ..x..), linewidth = 1, color = pokepal("rayquaza", spread = 1)) +
  geom_vline(aes(xintercept = median), linetype = "dotted", color = pokepal("rayquaza", spread = 1)) +
    labs(x = "Neoplasia Prevalence", y = "Families") +
  theme(
    axis.title.x = element_text(size = 10, hjust = 0.5, margin = margin(t = 20, b = 10)),
    axis.title.y = element_text(size = 10, angle = 90, hjust = 0.5, margin = margin(t = 20, b = 20)),
    legend.position = "none") + 
  xlim(0,0.5) 

```

### Median - 2SD without outliers

```{r top-bottom plot 2sd noout, fig.height = 8, fig.width = 10, dev = 'svg'}
ggplot(data = df_z_nooutlier, 
       aes(x = value, 
           y = Family)) +
  geom_point(data = subset(df_z_nooutlier, 
                        !(label_family_2sd %in% c("very_low_extreme", "normal", "very_high_extreme"))),
                        size = 4) +
  geom_point(data = subset(df_z_nooutlier, label_family_2sd %in% c("very_low_extreme", "normal", "very_high_extreme")),
               aes(shape = label_family_2sd, color = Family), size = 4) +
  scale_shape_manual(values = c("very_low_extreme" = 22, "normal" = 21, "very_high_extreme" = 24)) +
  stat_summary(fun.x = median, geom = "errorbar",
        aes(xmax = ..x.., xmin = ..x..), linewidth = 1, color = pokepal("rayquaza", spread = 1)) +
  geom_vline(aes(xintercept = median), linetype = "dotted", color = pokepal("rayquaza", spread = 1)) +
    labs(x = "Neoplasia Prevalence", y = "Families") +
  theme(
    axis.title.x = element_text(size = 10, hjust = 0.5, margin = margin(t = 20, b = 10)),
    axis.title.y = element_text(size = 10, angle = 90, hjust = 0.5, margin = margin(t = 20, b = 20)),
    legend.position = "none") + 
  xlim(0,0.25) 
```

## Histogram visualization for the three traits

```{r histogram}
hist(cancer_traits_filt$necropsy_count, xlab = "Necropsy Count", main = "Histogram of primates Necropsy Count")
hist(cancer_traits_filt$neoplasia_necropsy, xlab = "Neoplasia Count", main = "Histogram of primates Neoplasia Count")
hist(cancer_traits_filt$neoplasia_prevalence, xlab = "Neoplasia prevalence", main = "Histogram of primates Neoplasia Prevalence")
```

## Visual distribution of the three traits along the phylogeny
### Outlier highlight

```{r trait distribution, fig.height = 15, fig.width = 15, dev = 'svg'}
tree_species <- pruned_primates.tree$tip.label

NC <- cancer_traits_filt$necropsy_count
names(NC) <- tree_species
NC <- NC[!is.na(names(NC))]

NN <- cancer_traits_filt$neoplasia_necropsy
names(NN) <- tree_species
NN <- NN[!is.na(names(NN))]

NP <- cancer_traits_filt$neoplasia_prevalence
names(NP) <- tree_species
NP <- NP[!is.na(names(NP))]

# Necropsy Count
obj_nc<-contMap(pruned_primates.tree,NC,plot=FALSE)
obj_nc<-setMap(obj_nc,c("#077223", "#53EC2D", "white", "#F1F97C", 
                  "#F08431", "#F03131"))

plot(obj_nc,fsize=c(1),lwd=c(5),leg.txt="Necropsy Count")

# Neoplasia Count
obj_nn<-contMap(pruned_primates.tree,NN,plot=FALSE)
obj_nn<-setMap(obj_nn,c("#077223", "#53EC2D", "white", "#F1F97C", 
                  "#F08431", "#F03131"))
plot(obj_nn,fsize=c(1),lwd=c(5),leg.txt="Neoplasia Count")

# Neoplasia_prevalence
obj_np<-contMap(pruned_primates.tree,NP,plot=FALSE)
obj_np<-setMap(obj_np,c("#077223", "#53EC2D", "white", "#F1F97C", 
                  "#F08431", "#F03131"))
plot(obj_np,fsize=c(1),lwd=c(5),leg.txt="Neoplasia Prevalence")


```


## Scatterplots


```{r scatterplot, fig.height = 15, fig.width = 15, dev = 'svg'}

ggplot(cancer_traits_filt, aes(x=necropsy_count, y=neoplasia_necropsy, color=family))+ 
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  
  labs(y = "Neoplasia count", x = "Necropsy count", fill = "Neoplasia/Necropsy") +
  theme_minimal()

ggplot(cancer_traits_filt, aes(x=normalize(necropsy_count), y=normalize(neoplasia_necropsy), color=family))+ 
  geom_point() +
  geom_smooth(method=lm , color="red", fill="#69b3a2", se=TRUE) +
  labs(y = "Neoplasia count", x = "Necropsy count", fill = "Neoplasia/Necropsy") +
  theme_minimal()

```

## Summary table

```{r table}

# Clean and Summarize the Data
summary_data <- cancer_traits_filt %>%
  group_by(family) %>%
  # Summarize data
  summarize(
    n = n(),
    NC_Mean = mean(necropsy_count, na.rm = TRUE),
    NC_Median = median(necropsy_count, na.rm = TRUE),
    NC_SD = sd(necropsy_count, na.rm = TRUE),
    min_NC = min(necropsy_count, na.rm = TRUE),
    max_NC = max(necropsy_count, na.rm = TRUE),
    
    NN_Mean = mean(neoplasia_necropsy, na.rm = TRUE),
    NN_Median = median(neoplasia_necropsy, na.rm = TRUE),
    NN_SD = sd(neoplasia_necropsy, na.rm = TRUE),
    min_NN = min(neoplasia_necropsy, na.rm = TRUE),
    max_NN = max(neoplasia_necropsy, na.rm = TRUE),
    
    NP_Mean = mean(neoplasia_prevalence, na.rm = TRUE),
    NP_Median = median(neoplasia_prevalence, na.rm = TRUE),
    NP_SD = sd(neoplasia_prevalence, na.rm = TRUE),
    min_NP = min(neoplasia_prevalence, na.rm = TRUE),
    max_NP = max(neoplasia_prevalence, na.rm = TRUE))  %>% 
  
  # Compute the MLS Limits
  mutate(NC_Limits = paste(min_NC, "-", max_NC),
         NN_Limits = paste(min_NN, "-",max_NN),
         NP_Limits = paste(min_NP, "-",max_NP))

summary_data

# Use the gt function to create the table
table_display <- summary_data %>%
  select(family,n,NC_Mean,NC_Median,NC_SD,NC_Limits,
         NN_Mean,NN_Median,NN_SD,NN_Limits,
         NP_Mean,NP_Median,NP_SD,NP_Limits) %>%
  gt() %>%
  
  tab_header(title = "Table. Mean NC, NN and NP Computed Using All Records from our Primate Database") %>%
  
  # Formatting columns for better display
  fmt_number(columns = c("NC_Mean", "NC_Median", "NC_SD", "NN_Mean", "NN_Median", "NN_SD", "NP_Mean", "NP_Median", "NP_SD"), decimals = 2) %>%
  
  # Adding and removing table lines
  tab_options(
    table.border.top.style = "none",  # Remove the top border
    table.border.bottom.style = "solid",
    table.border.bottom.width = 2,
    column_labels.border.top.style = "double",
    column_labels.border.bottom.style = "double")

# Display the table
table_display

```

```{r table top bottoms without taking outliers into account} 

top1SD_spp <- df_z_nooutlier %>%
  filter(label_family == "high_extreme") %>%
  select(label_family,Species,value)

bottom1SD_spp <- df_z_nooutlier %>%
  filter(label_family == "low_extreme") %>%
  select(label_family,Species,value)

```
```{r}

# family_names <- unique(cancer_traits_filt$family)
# 
# get_uid <- function(family_name) {
#   # Try fetching UID for species
#   uid <- tryCatch({
#     ggimage::phylopic_uid(family_name)
#   }, error = function(e) {
#     return(NULL) # return NULL on error
#   })
#   return(uid)
# }
# 
# for uid in 
# 
# fam_uids <- sapply(family_names, get_uid)
# 
# header_images <- paste0('<img src="', primate_images, '" height="50px">') %>%
#   paste(collapse = " ")


```

```{r top_bottom table with animals fig}
# 
# # Load the ggplot2 library
# library(ggplot2)
# 
# # Combine the data
# combined_data <- rbind(
#   transform(top1SD_spp, category = "Top Species"),
#   transform(bottom1SD_spp, category = "Bottom Species")
# )
# 
# combined_data$Species <- gsub("_", " ", combined_data$Species)
# 
# # Load necessary libraries
# library(gt)
# 
# combined_data %>%
#   gt() %>%
#   tab_header(title = “PRIMATES NEOPLASY ANALSYS”) %>%
#   cols_label(
#     Species = 'Species',
#     neoplasia_prevalence = 'Neoplasia Prevalence') %>%
#   tab_spanner(
#     label = md('**Top Species**') %>% 
#   tab_style(
#     style = list(cell_fill(color = “#b2f7ef”),
#     cell_text(weight = “bold”)),
#     locations = cells_body(columns = mpg))%>%
#   tab_style(
#     style = list(cell_fill(color = “#ffefb5”),
#     cell_text(weight = “bold”)), 
#     locations = cells_body(columns = hp))

```

## Continous variable analysis

```{r, fig.height = 15, fig.width = 15, dev = 'svg'}

library(GGally)

# Check continuous variables distribution
p <- cancer_traits_filt %>% 
  select(necropsy_count, neoplasia_necropsy, neoplasia_prevalence) %>%
  ggpairs()

# Select 2 variables, remove missing variables and calculate spearman correlation from them
cor_numer <- cancer_traits_filt %>% 
  select(necropsy_count, neoplasia_necropsy, neoplasia_prevalence) %>% # select_if(is.numeric) 
  drop_na() %>%
  cor(., method = "spearman") #,use = "pairwise.complete.obs" )

#  Correlation plot
corrplot.mixed(cor_numer, number.digits = 2, tl.col = "black") # Set the color of text labels for correlation numbers

```

---
  title: "internal_validation"
author: "Miguel Ramon"
date: "`r Sys.Date()`"
output:
  html_document: default
pdf_document: default
---
  
################################## 

# FUNCTIONAL ANALYSIS

### PRIMATES' NEOPLASY PROJECT

### MIGUEL RAMON ALONSO

################################## 

## Aknowledgments
Noelia Rodriguez Perez (@NoeRzPz) for the logic involving the most part of this script.

```{r setup}

knitr::opts_knit$set(root.dir = "/home/miguel/IBE-UPF/TFM/Master_projects/NEOPLASY_PRIMATES")
knitr::opts_chunk$set(engine.path = list(
  python = '/home/miguel/TFM/Master_projects/NEOPLASY_PRIMATES/TreeCluster/venv/bin/python'))

```

```{r dirdef}

workingDir <- getwd()
dataDir <- file.path(workingDir, "Data")
resultsDir <- file.path(workingDir,"Out") 

```

```{r check-wd}

getwd()

```

### Seed and library loading

```{r,warning=FALSE,message=FALSE}

set.seed(1998)
library(ggplot2)
library(dplyr)
library(phytools)
library(ggsignif)
library(palettetown)

```

# Common functions

```{r common_functions}

# Function to read TSV files and return data frames
read_csv_to_df <- function(file) {
  df <- read.csv(file, sep = "\t")
  return(df)
}

# Function to create dirs
createDir <- function(directory) {
  if (!file.exists(directory)) {
    dir.create(directory, recursive = TRUE)
  }
}

# Noelia's function to run one-sided Phyl-Wilcox test
phylwilcoxtest <- function(tree, x, y, nsim=1000, data) {
  # Ensure that tree is a phylo object
  if (!inherits(tree, "phylo")) {
    stop("tree should be an object of class \"phylo\".")
  }
  
  # Ensure that x and y are column names in data and not separate vectors
  if (!(x %in% names(data)) || !(y %in% names(data))) {
    stop("x and y must be column names in data.")
  }
  
  # Extract x and y values from data, ordered by tree$tip.label
  x_values <- data[[x]]
  y_values <- data[[y]]
  
  # Convert x to factor
  x_values <- as.factor(x_values)
  # Check if factor has exactly 2 levels
  if (length(levels(x_values)) != 2) {
    stop("Factor does not have 2 levels.")
  }
  
  # Compute BM rate for y
  sig2 <- mean(pic(y_values, multi2di(tree, random = FALSE))^2)
  
  # Calculate the observed difference
  result <- wilcox.test(y_values ~ x_values, alternative = "greater", paired = FALSE, conf.int = 0.95)
  
  W.obs <- result$statistic
  
  # Simulate
  sims <- fastBM(tree, sig2 = sig2, nsim = (nsim - 1))
  W.null <- vector()
  W.null[1] <- W.obs
  
  for (i in 2:nsim) {
    # Recalculate group medians for the simulated data
    simresult <- wilcox.test(sims[,i-1] ~ x_values, alternative = "greater", paired = FALSE, conf.int = 0.95)
    W.sim <- simresult$statistic
    
    W.null[i] <- W.sim
  }
  
  # Calculate p-value
  P.W <- sum(W.null >= W.obs) / nsim
  
  # Return result
  obj <- list(Wobs = W.obs, Pval = P.W)
  class(obj) <- "phylt-test"
  obj
}

```

# Load needed objects
```{r object_load, message=FALSE, warning=FALSE}

# Load tree
primates_tree <- read.newick("Data/Phylo-233-GENOMES/science.abn7829_data_s4.nex.tree")
tree_species <- primates_tree$tip.label

# Internal validation with contrasts
intval_dfs_path <- "Out/8.Internal_validation/Oncovar/no_cont/"

# Get a list of all TSV files in the directory and its subdirectories
intval_csv_files <- list.files(path = intval_dfs_path, pattern = "\\.tab$", full.names = TRUE, recursive = FALSE)


# Use lapply to read all TSV files into a list of data frames
intval_dfs <- setNames(lapply(intval_csv_files, read_csv_to_df), tools::file_path_sans_ext(basename(intval_csv_files)))

```

# Internal validation procedure
```{r internal_validation, fig.height = 7, fig.width = 7, dev = "svg"}

intval_results <- list()
intval_graphs <- list()
graphDir <- file.path(intval_dfs_path, "Graphs") # Change if also tt
createDir(graphDir)

# My default way of working with a multilist of traits
for (intval in names(intval_dfs)) {
  intval_df <- intval_dfs[[intval]]
  
  # Filter genes with more than 5 cases of each level of the factor type_neoplasia_prevalence
  intval_df <- intval_df %>%
    group_by(Gene) %>%
    filter( sum(type_neoplasia_prevalence == "High-NP") >= 3 & sum(type_neoplasia_prevalence == "Low-NP") >= 3) %>%
    ungroup()  # Ungroup if you need to perform further ungrouped operations
  
  for (gene in unique(intval_df$Gene)) {
    gene_data <- intval_df %>%
      filter(Gene == gene)
    
    # Find the common names between tree labels and trait df
    common_names <- intersect(primates_tree$tip.label, gene_data$label)
    
    # Prune tree, keeping the species from our trait dataframe, drop tips that are NOT in common_names
    pruned_tree <- drop.tip(primates_tree, setdiff(primates_tree$tip.label, common_names))
    
    # Make sure the tree and the data have the same species order
    gene_data <- gene_data[match(pruned_tree$tip.label, gene_data$label), ]
   
    # Run RRPP
    # result_phyANOVA <- phylANOVA(pruned_tree, gene_data$type_neoplasia_prevalence, gene_data$neoplasia_prevalence, nsim = 1000)
    result_wiltest <- phylwilcoxtest(tree = pruned_tree, x = "type_neoplasia_prevalence", y = "neoplasia_prevalence", nsim = 1000, data = gene_data)

    # Store the results
    intval_results[[intval]][[gene]] <- result_wiltest

      
    # for (gene in names(intval_results[[intval]])) {
    #   cat("\nGene:", gene)
    #   print(intval_results[[intval]][[gene]]$Pval)
    #   pval <- c(pval, intval_results[[intval]][[gene]]$Pval)
    #   intval_results[[intval]][[gene]]$Padj <- p.adjust(pval, method = "BH")
    #   print(intval_results[[intval]][[gene]]$Padj)
    # }
    # Plot of trait values by predictor categories

    NPplot <- ggplot(gene_data, aes(x = type_neoplasia_prevalence, y = neoplasia_prevalence, fill = type_neoplasia_prevalence)) +
      geom_boxplot() +
      geom_signif(comparisons = list(c("High-NP", "Low-NP")),
                  map_signif_level = TRUE,
                  textsize = 6) +  # Adjust text size as needed
      geom_text(data = gene_data[which(gene_data$neoplasia_prevalence %in% boxplot.stats(gene_data$neoplasia_prevalence)$out), ],
                aes(label = label),
                vjust = -0.5, hjust = -0.2, size = 6) +
      labs(x = "CAAS Predictor", y = "Neoplasia Prevalence Value", title = paste("PhyloWILCOXON test for", gene), caption = paste("Pval: ", intval_results[[intval]][[gene]]$Pval)) +
  theme(
    axis.text.y = element_text(size = 12),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 15, hjust = 0.5, margin = margin(t = 20, b = 20)),
    axis.title.y = element_text(size = 15, angle = 90, hjust = 0.5, margin = margin(l = 20, r = 20)),
    plot.title = element_text(size = 20, face = "bold", color = "black", hjust = 0.5, margin = margin(t = 20, b = 10)),
    plot.subtitle = element_text(size = 15, face = "bold", color = "black", hjust = 0.5, margin = margin(t = 20, b = 10)),
    plot.caption = element_text(size = 15, face = "bold", margin = margin(t = 10, b = 20)),
    legend.position = "none")

    
    # Add the plot to our list, named by the gene for easier reference later
    intval_graphs[[intval]][[gene]] <- NPplot
    
  }

  # Adjust p-values using Benjamini-Hochberg method

  # # print the plot for a specific gene:
  # print(graphs[["DNAH8"]])
  # print(graphs[["SRRM5"]])
  # results[["SRRM5"]]
  # Or loop through the list to print all plots
  #for (gene in names(graphs)) {
  #  print(graphs[[gene]])
  #}
  
  # If you want to save all plots to files
  for (gene in names(intval_graphs[[intval]])) {
    ggsave(file.path(graphDir, paste0(intval, "plot_", gene, ".png")), intval_graphs[[intval]][[gene]], width = 10, height = 8)
  }
} # :)

```

result_phyA <- phytools::phyl.pairedttest(tree = pruned_tree, y = gene_data$neoplasia_prevalence, x = gene_data$type_neoplasia_prevalence, nsim = 1000)